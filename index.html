<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>值班 – Jiajia / 姐姐</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111827">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

<style>
  :root{
    --bg:#0f172a; --text:#f5f5f5; --muted:#cbd5e1; --border:rgba(255,255,255,.14);
    --j:#ec4899; --s:#8b5cf6;
    --card:rgba(17,24,39,.82); --glass:rgba(255,255,255,.06);
    --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box}
  /* supprime l'effet de surbrillance au tap sur mobile */
  *{ -webkit-tap-highlight-color: transparent; }
  html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:var(--bg);position:relative;overflow-y:scroll;touch-action:pan-y;
  }
  /* 背景图（粉色） — responsive cover, pas de "fixed" (iOS friendly) */
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background-image:
      linear-gradient(180deg, rgba(236,72,153,.25), rgba(139,92,246,.25)),
      url("icons/fond.jpg");
    background-repeat: no-repeat, no-repeat;
    background-position: center, center;
    background-size: cover, cover;
    background-attachment: scroll; /* éviter fixed sur mobile */
    filter:saturate(1.05);
    opacity:.55;
    z-index:-2;
    will-change: transform;
    transform: translateZ(0);
  }
  /* Forcer le scroll (pas fixed) sur écrans tactiles */
  @media (pointer:coarse){
    body::before{ background-attachment: scroll; }
  }

  body::after{
    content:"";position:fixed;inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.30));
    z-index:-1
  }

  .container{max-width:880px;margin:0 auto;padding:16px 16px 120px}

  .calendar{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:12px;
  }
  .top-rows{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .legend{display:flex;align-items:center;gap:10px}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;background:var(--glass)}
  .dot{width:10px;height:10px;border-radius:999px}
  .dot.j{background:var(--j)} .dot.s{background:var(--s)}

  .btn{
    background:var(--glass); border:1px solid var(--border); color:var(--text);
    border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); cursor:pointer
  }
  .btn.small{padding:8px 12px}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn:active{transform:translateY(1px)}

  /* Anti-sélection / anti-callout pour tous les boutons & éléments cliquables */
  button, .btn, .month-btn, .chip, .mp-item {
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none; /* iOS: pas de menu au long-press */
  }
  /* si des images se trouvent dans des boutons, on évite de les sélectionner/drag */
  button img, .btn img { user-select: none; -webkit-user-drag: none; pointer-events: none; }

  /* 月份标题（放在日期上方） */
  .month-inline{
    text-align:center;font-weight:800;font-size:18px;margin:2px 0 8px;
    text-transform:none;
  }

  /* 星期标题（与下方网格对齐） */
  .weekdays{
    display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:6px 0 10px;
    color:var(--muted);font-size:13px;font-weight:700;text-align:center;
  }

  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cell{
    aspect-ratio:1/1;background:var(--glass);border:1px solid var(--border);border-radius:14px;
    display:flex;align-items:center;justify-content:center;position:relative;user-select:none;cursor:pointer;
    transition:transform .05s ease, outline-color .2s, background-color .2s;outline:2px solid transparent;
  }
  .cell:active{ transform:scale(.985) }
  .cell.out{ opacity:.45 }
  .num{ position:relative; z-index:2; font-weight:700; }
  .badge{ position:absolute; inset:4px; border-radius:12px; background:transparent; z-index:1; transition:background-color .2s, box-shadow .2s }
  .j .badge{ background:rgba(236,72,153,.18); box-shadow:0 0 0 2px rgba(236,72,153,.45) inset }
  .s .badge{ background:rgba(139,92,246,.18); box-shadow:0 0 0 2px rgba(139,92,246,.45) inset }

  /* 底部栏：导航固定位置，高度更大 */
  .footer{
    position:fixed;left:0;right:0;bottom:0;
    padding:14px 12px;min-height:84px;border-top:1px solid var(--border);
    backdrop-filter:blur(8px);
    background:linear-gradient(0deg, rgba(17,24,39,.95), rgba(17,24,39,.70));
    display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;
  }
  .nav-group{
    display:grid;grid-template-columns:56px minmax(180px, 60vw) 56px;align-items:center;justify-items:center;
    justify-self:center;
  }
  .month-btn{
    width:100%;margin:0;border:none;background:transparent;color:var(--text);font-size:18px;font-weight:800;cursor:pointer;
    padding:6px 10px;border-radius:10px;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-align:center;
  }
  .month-btn:hover{background:rgba(255,255,255,.06)}
  .month-btn:active{transform:translateY(1px)}
  .install{justify-self:end}

  dialog#monthPicker{
    border:none;border-radius:16px;padding:0;max-width:min(440px,96vw);width:100%;
    background:var(--card);color:var(--text);box-shadow:var(--shadow);overflow:hidden;
  }
  dialog#monthPicker::backdrop{background:rgba(0,0,0,.6)}
  .mp-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border)}
  .mp-title{font-weight:700}
  .mp-list{max-height:60vh;overflow:auto}
  .mp-item{
    width:100%;text-align:left;background:transparent;border:none;color:var(--text);
    padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;
  }
  .mp-item:hover{background:rgba(255,255,255,.06)}
  .mp-item.selected{outline:2px solid rgba(236,72,153,.5); background:rgba(236,72,153,.10)}
</style>




</head>
<body>

  <div class="container">
    <div class="calendar" id="calendar">
      <div class="top-rows">
        <div class="controls">
          <button class="btn" id="invertAB">切换A/B（将重置）</button>
          <button class="btn" id="resetBtn">重置手动修改</button>
        </div>
        <div class="legend">
          <span class="chip"><span class="dot j"></span>Jiajia</span>
          <span class="chip"><span class="dot s"></span>姐姐</span>
        </div>
      </div>

      <!-- 月份（中文） -->
      <div class="month-inline" id="monthInline"></div>

      <!-- 星期标题（与下面网格同样的7列布局，居中对齐） -->
      <div class="weekdays" id="weekdays"></div>

      <!-- 日期 -->
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- 月份选择器 -->
  <dialog id="monthPicker">
    <div class="mp-head">
      <div class="mp-title">选择月份</div>
      <button class="btn small" id="mpClose">关闭</button>
    </div>
    <div class="mp-list" id="mpList"></div>
  </dialog>

  <!-- 底部栏：固定左右箭头 + 中间月份按钮 -->
  <div class="footer">
    <div></div>
    <div class="nav-group">
      <button class="btn small" id="prevMonth" aria-label="上个月">◀</button>
      <button class="month-btn" id="monthLabel" aria-haspopup="dialog" aria-controls="monthPicker" title="选择月份"></button>
      <button class="btn small" id="nextMonth" aria-label="下个月">▶</button>
    </div>
    <button class="btn small install" id="installBtn" hidden>安装</button>
  </div>

  <script>
  // ---------- 日期（UTC） ----------
  const fmtMonthZH = new Intl.DateTimeFormat('zh-CN',{year:'numeric',month:'long'}); // 例：2025年8月
  const toUTCDate = (d)=> new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const ymd = (d)=> `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
  const fromYMD = (s)=>{ const [y,m,d]=s.split('-').map(Number); return new Date(Date.UTC(y,m-1,d)); }
  function mondayOf(date){ const d=toUTCDate(date); const wd=d.getUTCDay(); const diff=(wd===0?-6:1-wd); d.setUTCDate(d.getUTCDate()+diff); d.setUTCHours(0,0,0,0); return d; }
  function sundayOf(date){ const m=mondayOf(date); const s=new Date(m); s.setUTCDate(m.getUTCDate()+6); return s; }
  function addDaysUTC(d,days){ const n=new Date(d); n.setUTCDate(n.getUTCDate()+days); return n; }
  function weeksBetween(a,b){ return Math.round((mondayOf(b)-mondayOf(a))/(7*86400000)); }

  // ---------- 状态 ----------
  const STORAGE_KEY='garde-calendar.v7';
  const defaultState = ()=>{
    const today = new Date();
    return { baselineMondayISO: ymd(mondayOf(today)), baselineOwner: 'jiajia', dayOverrides: {} };
  };
  function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw? {...defaultState(), ...JSON.parse(raw)} : defaultState(); }catch{ return defaultState(); } }
  let state = load();
  const save = ()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

  function baseOwnerForDate(date){
    const base = fromYMD(state.baselineMondayISO);
    const w = weeksBetween(base, date);
    const isEven = (w % 2 === 0);
    return isEven ? state.baselineOwner : (state.baselineOwner==='jiajia'?'soeur':'jiajia'); // 存值仍用 'soeur' 以兼容之前逻辑
  }
  function ownerForDate(date){
    const k = ymd(toUTCDate(date));
    return state.dayOverrides[k] || baseOwnerForDate(date);
  }

  // ---------- 渲染月份 ----------
  const grid = document.getElementById('grid');
  const weekdaysEl = document.getElementById('weekdays');
  const monthLabelEl = document.getElementById('monthLabel');
  const monthInlineEl = document.getElementById('monthInline');

  const dayNamesZH = ['周一','周二','周三','周四','周五','周六','周日']; // 与下方7列严格对齐
  weekdaysEl.innerHTML = dayNamesZH.map(n=>`<div style="text-align:center">${n}</div>`).join('');

  const today = new Date();
  const startMonth = new Date(today.getFullYear(), today.getMonth(), 1); // 当前月
  const monthsAhead = 12; // 0..12
  let currentOffset = 0;

  function render(){
    // 导航可用性
    document.getElementById('prevMonth').disabled = currentOffset<=0;
    document.getElementById('nextMonth').disabled = currentOffset>=monthsAhead;

    const m = new Date(startMonth.getFullYear(), startMonth.getMonth()+currentOffset, 1);
    const monthStartUTC = toUTCDate(m);
    const monthEndUTC = toUTCDate(new Date(m.getFullYear(), m.getMonth()+1, 0));
    const labelZH = fmtMonthZH.format(m);

    // 底部按钮 & 中间标题（中文）
    monthLabelEl.textContent = labelZH;
    monthInlineEl.textContent = labelZH;

    // 仅显示必要的周
    const firstMonday = mondayOf(monthStartUTC);
    const lastSunday  = sundayOf(monthEndUTC);
    const totalDays = Math.round((lastSunday - firstMonday)/86400000) + 1; // 7的倍数
    grid.innerHTML='';

    for(let i=0;i<totalDays;i++){
      const d = addDaysUTC(firstMonday, i);
      const cell = document.createElement('div');
      cell.className = 'cell';

      const out = d < monthStartUTC || d > monthEndUTC;
      if(out) cell.classList.add('out');

      const owner = ownerForDate(d);
      cell.classList.add(owner==='jiajia' ? 'j' : 's');

      const badge = document.createElement('div'); badge.className='badge';
      const num = document.createElement('div'); num.className='num'; num.textContent = d.getUTCDate();
      cell.appendChild(badge); cell.appendChild(num);

      // 点击切换 Jiajia <-> 姐姐
      cell.addEventListener('click', ()=>{
        const k = ymd(d);
        const cur = ownerForDate(d);
        const next = (cur==='jiajia') ? 'soeur' : 'jiajia';
        state.dayOverrides[k] = next;
        if(state.dayOverrides[k] === baseOwnerForDate(d)){ delete state.dayOverrides[k]; }
        save(); render();
      });

      grid.appendChild(cell);
    }

    refreshMonthPickerSelection();
  }

  // ---------- 箭头导航 ----------
  document.getElementById('prevMonth').onclick = ()=>{ if(currentOffset>0){ currentOffset--; render(); } };
  document.getElementById('nextMonth').onclick = ()=>{ if(currentOffset<monthsAhead){ currentOffset++; render(); } };

  // ---------- 全局切换 / 重置 ----------
  document.getElementById('invertAB').onclick = ()=>{
    if(!confirm("确定切换 A/B 并清除所有手动修改吗？")) return;
    state.baselineOwner = (state.baselineOwner==='jiajia') ? 'soeur' : 'jiajia';
    state.dayOverrides = {}; save(); render();
  };
  document.getElementById('resetBtn').onclick = ()=>{
    if(!confirm("确定清除所有手动修改吗？")) return;
    state.dayOverrides = {}; save(); render();
  };

  // ---------- 月份选择器 ----------
  const monthPicker = document.getElementById('monthPicker');
  const mpList = document.getElementById('mpList');
  const mpClose = document.getElementById('mpClose');

  function buildMonthPicker(){
    mpList.innerHTML = '';
    for(let i=0;i<=monthsAhead;i++){
      const date = new Date(startMonth.getFullYear(), startMonth.getMonth()+i, 1);
      const btn = document.createElement('button');
      btn.className = 'mp-item';
      btn.dataset.offset = i;
      btn.textContent = fmtMonthZH.format(date); // 中文
      btn.addEventListener('click', ()=>{
        currentOffset = i; monthPicker.close(); render();
      });
      mpList.appendChild(btn);
    }
    refreshMonthPickerSelection();
  }
  function refreshMonthPickerSelection(){
    const items = mpList.querySelectorAll('.mp-item');
    items.forEach(it => it.classList.toggle('selected', Number(it.dataset.offset)===currentOffset));
  }
  monthLabelEl.addEventListener('click', ()=>{
    buildMonthPicker();
    monthPicker.showModal();
  });
  mpClose.addEventListener('click', ()=> monthPicker.close());
  monthPicker.addEventListener('click', (e)=>{
    const rect = monthPicker.getBoundingClientRect();
    const inDialog = (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom);
    if(!inDialog) monthPicker.close();
  });

  // ---------- 全局滑动（任意位置） ----------
  let startX=null, startY=null, startTime=0;
  const SWIPE_MIN_X = 50;   // px
  const SWIPE_MAX_Y = 60;   // 垂直容忍
  const SWIPE_MAX_MS = 600; // 最大时间

  function handleStart(e){
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX; startY = t.clientY; startTime = Date.now();
  }
  function handleEnd(e){
    if(startX===null) return;
    const t = e.changedTouches ? e.changedTouches[0] : e;
    const dx = t.clientX - startX;
    const dy = Math.abs(t.clientY - startY);
    const dt = Date.now() - startTime;
    startX = null;

    if (document.getElementById('monthPicker').open) return; // 选择器打开时不处理滑动
    if(dy > SWIPE_MAX_Y || dt > SWIPE_MAX_MS) return;

    if(dx <= -SWIPE_MIN_X && currentOffset < monthsAhead){
      currentOffset++; render();
    }else if(dx >= SWIPE_MIN_X && currentOffset > 0){
      currentOffset--; render();
    }
  }
  window.addEventListener('touchstart', handleStart, {passive:true});
  window.addEventListener('touchend', handleEnd,   {passive:true});
  window.addEventListener('pointerdown', handleStart, {passive:true});
  window.addEventListener('pointerup',   handleEnd,   {passive:true});

  // ---------- PWA ----------
  let deferredPrompt=null;
  const installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt',(e)=>{
    e.preventDefault(); deferredPrompt = e; installBtn.hidden=false;
  });
  installBtn.addEventListener('click', async ()=>{
    if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true;
  });
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

  render();
  </script>
</body>
</html>
